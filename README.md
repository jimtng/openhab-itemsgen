# openhab-itemsgen - OpenHAB Things and Items Generator

A template-based OpenHAB .things and .items file generator written in Ruby using the ERB template engine.

`device list` + `template` => `.items` and `.things` files

Things and items definitions are usually repetitive when you have multiple devices of the same type. The process of adding and maintaining .things and .items files involves tedious copy pasting and renaming. Changing how they are all defined is even more tedious.

`openhab-itemsgen` enables you to generate .things and .items files for OpenHAB using pre-set templates.

## Status

- It works, but still in active development, not yet used in production
- This is a complete rewrite of [ohgen](https://github.com/jimtng/ohgen) with a few changes:
  - Rewritten in Ruby
  - Simplified yaml structure
  - Using ERB template engine instead of Jinja2. As a result, the templates from ohgen will need to be rewritten

## Features

- things channels and items fields output are nicely aligned
- Use the power of Ruby inside the template
- Includes helper methods to make template writing easier
- Easily add default icon, groups, tags, and metadata
- Be as flexible or as simple as desired

The list of your devices are maintained in a `devices.yaml` file. Example:

```yaml
settings:
  things:
    # output-file: ../things/generated.things
    output_file: /openhab/conf/things/test.things
    header: |+
      // This file is automatically generated

  items:
    # output-file: ../items/generated.items
    output_file: /openhab/conf/items/test.items
    header: |+
      // This file is automatically generated

LivingRoom_Window:
  template: aqara-contact
  thingid: livingroom-window-contact
  groups:
    - gWindows
    - gLivingRoom
  tags:
    - Window
```

Coupled with an appropriate template (see below), this will render into:

.things file

```
// This file is automatically generated

Thing mqtt:topic:mosquitto:livingroom-window-contact (mqtt:broker:mosquitto) {
    Channels:
         Type contact : contact      [ stateTopic="zigbee/livingroom-window-contact/contact", on="false", off="true"  ]
         Type number  : linkquality  [ stateTopic="zigbee/livingroom-window-contact/linkquality" ]
         Type contact : availability [ stateTopic="zigbee/livingroom-window-contact/availability", on="online", off="offline" ]
         Type number  : battery      [ stateTopic="zigbee/livingroom-window-contact/battery" ]
}
```

.items file:

```
// This file is automatically generated

Contact LivingRoom_Window_State             "Living Room Window"                                               <door>    (gWindows, gLivingRoom, gContactSensor)                    ["Window"]                { channel="mqtt:topic:mosquitto:livingroom-window-contact:contact" }
Number  LivingRoom_Window_Link              "Living Room Window Link"                                          <network> (gSignalStrength)                                                                    { channel="mqtt:topic:mosquitto:livingroom-window-contact:linkquality" }
Number  LivingRoom_Window_Battery           "Living Room Window Battery [%d%%]"                                <battery> (gBatteries)                                                                         { channel="mqtt:topic:mosquitto:livingroom-window-contact:battery", expire="1h" }
Contact LivingRoom_Window_Availability      "Living Room Window Availability [MAP(availability.map):%s]"                 (gAvailability)                                                                      { channel="mqtt:topic:mosquitto:livingroom-window-contact:availability" }
```

The structure of the data for each item is mostly up to you, however it must match with the template. The template would be referring to the data structure from the YAML structure.

## Templates

Template files are stored in `templates/` subdirectory with an `.erb` extension. Each template file contains the template for both the things and items definition. `openhab-itemsgen` will split them into their corresponding .things and .items file.

Example for `templates/aqara-contact.erb`

```ruby
Thing mqtt:topic:mosquitto:<%= thingid %> (mqtt:broker:mosquitto) {
    Channels:
        Type contact: contact      [ stateTopic="zigbee/<%= thingid %>/contact", on="false", off="true"  ]
        Type number : linkquality  [ stateTopic="zigbee/<%= thingid %>/linkquality" ]
        Type contact: availability [ stateTopic="zigbee/<%= thingid %>/availability", on="online", off="offline" ]
        Type number : battery      [ stateTopic="zigbee/<%= thingid %>/battery" ]
}

Contact <%= name %>_State   "<%= label %>"  <<%= icon || 'door' %>>     <%= make_groups groups, 'gContactSensor' %> <%= tags&.tags %> { channel="mqtt:topic:mosquitto:<%= thingid %>:contact"<%= metadata&.metadata %> }
Number  <%= name %>_Link    "<%= label %> Link"      <network> (gSignalStrength) { channel="mqtt:topic:mosquitto:<%= thingid %>:linkquality" }
Number  <%= name %>_Battery "<%= label %> Battery [%d%%]" <battery> (gBatteries) { channel="mqtt:topic:mosquitto:<%= thingid %>:battery", expire="1h" }
Contact <%= name %>_Availability "<%= label %> Availability [MAP(availability.map):%s]" (gAvailability) { channel="mqtt:topic:mosquitto:<%= thingid %>:availability" }
```

## Helper methods

For ease of template writing and brevity, several helper methods are available:

- `Array#groups` will render into `(elem1, elem2, ...)`

  For example, an array called `mygroups` created in yaml:

  ```yaml
  LightRoom_Light:
    mygroups:
      - Group1
      - Group2
  ```

  can be used inside the template as `<%= mygroups.groups %>` to generate: `(Group1, Group2)` complete with the parentheses

- `Array#tags` will render into `["elem1", "elem2", ...]`
- `Array#metadata` will render into `, elem1, elem2, ...`. Furthermore, if the element is a hash, it will be converted into `key="value"` syntax
- `Array#full_metadata` will render into `{ elem1, elem2, ... }`

Several predefined variables / methods are also available for the template:

- `name`: the name of the device id from the yaml, e.g. `LivingRoom_Light`
- `label`: unless specified in the yaml, the name of the device converted to human readable, e.g. `LivingRoom_Light` => `Living Room Light`
- `thingid`: unless specified in the yaml, a lower case version of `name`, with `_` converted to `-`
- `room`: unless specified in the yaml, the first part of `name` before the underscore, converted to human readable, e.g. `Living Room`
- `name_parts`: Split `name` parts delimited by underscores, e.g. `['LivingRoom', 'Light']`

TODO
